# ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITICAL WARNING ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

## üö® DISCLAIMER - READ BEFORE PROCEEDING üö®

<div align="center">

# ‚ö†Ô∏è THIS DOCUMENT IS AI-GENERATED ‚ö†Ô∏è

### **CONTENT MAY CONTAIN HALLUCINATIONS OR INACCURACIES**

# üî¥ FLASHING FIRMWARE MAY PERMANENTLY BRICK YOUR RADIO üî¥

**USE AT YOUR OWN RISK**

**NO WARRANTY OR GUARANTEE OF ACCURACY OR FUNCTIONALITY**

</div>

---

**This guide has been generated by AI and may contain:**
- ‚ùå Incorrect or incomplete instructions
- ‚ùå Hallucinated or non-existent commands/procedures
- ‚ùå Inaccurate hardware specifications
- ‚ùå Dangerous or destructive operations

**Flashing firmware built from this project may:**
- üî• **Permanently damage your radio**
- üî• **Void your warranty**
- üî• **Destroy calibration data**
- üî• **Make your radio unusable**
- üî• **Require expensive repairs or replacement**

**By proceeding, you acknowledge that:**
- You understand the risks
- You have backed up your original firmware
- You are solely responsible for any damage
- The authors/contributors bear no liability

---

# Building and Flashing Guide

This guide provides detailed instructions for compiling and flashing the Radtel RT-950 Pro firmware.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Building the Firmware](#building-the-firmware)
- [Flashing the Firmware](#flashing-the-firmware)
- [Verification](#verification)
- [Troubleshooting](#troubleshooting)

---

## Prerequisites

### Required Tools

1. **ARM GCC Toolchain** (arm-none-eabi-gcc 10.x or later)
2. **CMake** (3.20 or later)
3. **Make** or **Ninja** build system
4. **OpenOCD** (for SWD/JTAG flashing, optional)

### Platform-Specific Installation

#### Windows

1. **ARM GCC Toolchain**
   - Download from: https://developer.arm.com/downloads/-/gnu-rm
   - Choose the latest version (e.g., `gcc-arm-none-eabi-10.3-2021.10-win32.exe`)
   - Install to `C:\Program Files (x86)\GNU Arm Embedded Toolchain\` (default)
   - Add to PATH: `C:\Program Files (x86)\GNU Arm Embedded Toolchain\10 2021.10\bin`
   - Verify installation:
     ```powershell
     arm-none-eabi-gcc --version
     ```

2. **CMake**
   - Download from: https://cmake.org/download/
   - Install with installer, or use Chocolatey:
     ```powershell
     choco install cmake
     ```
   - Verify installation:
     ```powershell
     cmake --version
     ```

3. **Make**
   - Option 1: Install via Chocolatey:
     ```powershell
     choco install make
     ```
   - Option 2: Use `mingw32-make` (comes with MinGW/MSYS2)
   - Option 3: Use `ninja` (faster):
     ```powershell
     choco install ninja
     ```

4. **OpenOCD** (for SWD flashing)
   - Download from: https://openocd.org/pages/download.html
   - Or use pre-built binaries: https://github.com/xpack-dev-tools/openocd-xpack/releases
   - Extract to a folder (e.g., `C:\openocd`)
   - Add `C:\openocd\bin` to PATH

#### Linux (Ubuntu/Debian)

```bash
sudo apt update
sudo apt install -y gcc-arm-none-eabi cmake make ninja-build openocd
```

Verify installations:
```bash
arm-none-eabi-gcc --version
cmake --version
make --version
ninja --version
openocd --version
```

#### macOS

Using Homebrew:

```bash
brew install arm-none-eabi-gcc cmake make ninja openocd
```

Verify installations:
```bash
arm-none-eabi-gcc --version
cmake --version
make --version
ninja --version
openocd --version
```

---

## Building the Firmware

### Step 1: Clone the Repository

If you haven't already:

```bash
git clone https://github.com/Dadud/radtel-950-pro.git
cd radtel-950-pro
```

### Step 2: Create Build Directory

```bash
# Create build output directory
mkdir -p build/output
cd build/output
```

**Windows PowerShell:**
```powershell
New-Item -ItemType Directory -Force -Path build\output
cd build\output
```

### Step 3: Configure CMake

Configure the build system:

```bash
cmake ../.. -DCMAKE_BUILD_TYPE=Release
```

**Build Types:**
- `Release`: Optimized build (`-Os`, no debug symbols) - **Recommended for flashing**
- `Debug`: Debug build (`-O0 -g3`) - For development and debugging

**Windows Note:** If CMake can't find the ARM toolchain, specify it explicitly:

```powershell
cmake ../.. -DCMAKE_BUILD_TYPE=Release `
  -DCMAKE_C_COMPILER="C:\Program Files (x86)\GNU Arm Embedded Toolchain\10 2021.10\bin\arm-none-eabi-gcc.exe"
```

### Step 4: Build

**Using Make:**
```bash
make -j$(nproc)        # Linux/macOS
make -j4               # Or specify number of cores manually
```

**Windows:**
```powershell
# Using make (if installed)
make -j4

# Or using ninja (faster)
cmake ../.. -G Ninja -DCMAKE_BUILD_TYPE=Release
ninja
```

**Using Ninja (all platforms):**
```bash
cmake ../.. -G Ninja -DCMAKE_BUILD_TYPE=Release
ninja
```

### Step 5: Verify Build Output

After successful build, you should see output files in `build/output/`:

```
build/output/
‚îú‚îÄ‚îÄ rt950pro_firmware.elf    # ELF file (for debugging)
‚îú‚îÄ‚îÄ rt950pro_firmware.bin    # Binary file (for flashing)
‚îú‚îÄ‚îÄ rt950pro_firmware.hex    # Intel HEX format
‚îú‚îÄ‚îÄ rt950pro_firmware.map    # Memory map file
‚îî‚îÄ‚îÄ CMakeCache.txt
```

**Check firmware size:**
```bash
# Linux/macOS
arm-none-eabi-size rt950pro_firmware.elf

# Windows
arm-none-eabi-size.exe rt950pro_firmware.elf
```

Expected output example:
```
   text    data     bss     dec     hex filename
  12345     234     567   13146    335a rt950pro_firmware.elf
```

- `text`: Code size (should fit in 1MB flash)
- `data`: Initialized data
- `bss`: Uninitialized data (should fit in 96KB RAM)

---

## Flashing the Firmware

### ‚ö†Ô∏è CRITICAL WARNINGS

1. **ALWAYS BACKUP YOUR ORIGINAL FIRMWARE FIRST**
   - The original firmware may contain calibration data
   - You may need it to restore your radio
   - Use SWD/JTAG to read the full flash before flashing

2. **EXPERIMENTAL FIRMWARE**
   - This firmware is under active development
   - It may not be fully functional
   - You may brick your radio - **use at your own risk**

3. **ANTENNA REQUIREMENT**
   - Always have an antenna connected when transmitting
   - Transmitting without an antenna can damage the PA

### Method 1: SWD/JTAG (Recommended)

SWD (Serial Wire Debug) is the most reliable method and allows you to backup your original firmware.

#### Hardware Requirements

- ST-Link V2/V3, J-Link, or compatible SWD programmer
- Connection to RT-950 Pro SWD pins:
  - **SWDIO**: PA13 (pin on MCU)
  - **SWCLK**: PA14 (pin on MCU)
  - **GND**: Ground connection
  - **VDD**: 3.3V reference (for level detection, **do not power the radio from the programmer**)

#### Step 1: Connect Hardware

1. Power off the radio
2. Connect SWD programmer to the SWD pins
3. Connect ground
4. **Do NOT connect VDD** (radio should be powered by its own battery/PSU)
5. Power on the radio

#### Step 2: Backup Original Firmware

**Using OpenOCD (ST-Link):**

Create a backup script `backup_flash.cfg`:

```tcl
source [find interface/stlink.cfg]
source [find target/stm32f4x.cfg]

# Connect
init
halt

# Read entire flash (1MB = 0x100000 bytes)
dump_image backup_original.bin 0x08000000 0x100000

# Verify read
verify_image backup_original.bin 0x08000000

shutdown
```

Run backup:
```bash
openocd -f backup_flash.cfg
```

**Using ST-Link Utility (Windows):**
1. Open ST-Link Utility
2. Connect to target
3. File ‚Üí Save File...
4. Address: `0x08000000`, Size: `0x100000` (1MB)
5. Save as `backup_original.bin`

#### Step 3: Flash New Firmware

**Using OpenOCD:**

```bash
cd build/output
openocd -f interface/stlink.cfg \
        -f target/stm32f4x.cfg \
        -c "program rt950pro_firmware.elf verify reset exit"
```

**Windows PowerShell:**
```powershell
cd build\output
openocd -f interface/stlink.cfg -f target/stm32f4x.cfg -c "program rt950pro_firmware.elf verify reset exit"
```

**Alternative: Flash binary file directly:**
```bash
openocd -f interface/stlink.cfg \
        -f target/stm32f4x.cfg \
        -c "program rt950pro_firmware.bin 0x08000000 verify reset exit"
```

**Using ST-Link Utility (Windows GUI):**
1. Open ST-Link Utility
2. Connect to target
3. File ‚Üí Open File... ‚Üí Select `rt950pro_firmware.hex` or `.bin`
4. Target ‚Üí Program & Verify
5. Verify address: `0x08000000`
6. Click "Start"

**Using ST-Link Command Line (Windows):**
```powershell
ST-Link_CLI.exe -c SWD -P rt950pro_firmware.hex -V -Rst
```

**Using J-Link (if using J-Link programmer):**

```bash
JLinkExe -device STM32F403RC -if SWD -speed 4000 -autoconnect 1
```

Then in J-Link console:
```
loadfile rt950pro_firmware.hex
r
g
exit
```

Or one-liner:
```bash
JLinkExe -device STM32F403RC -if SWD -speed 4000 -autoconnect 1 \
  -CommanderScript "loadfile rt950pro_firmware.hex; r; g; exit"
```

### Method 2: USB CDC Bootloader (Experimental)

**Note:** The OEM bootloader may perform signature verification and reject unsigned images. This method may not work without bypassing signature checks.

#### Requirements

- Original Radtel firmware bootloader must be present
- Radio must enter bootloader mode (usually by holding a button combination on power-on)
- USB connection to PC

#### Procedure

1. Enter bootloader mode (consult OEM documentation)
2. Connect via USB - should appear as COM port (Windows) or `/dev/ttyACM0` (Linux)
3. Use custom flashing script (if available):

```bash
# If radtel_flash.py script exists
python firmware/scripts/radtel_flash.py \
    --port COM3 \
    --raw build/output/rt950pro_firmware.bin
```

**Bootloader Protocol:**
- Frame format: `0xAA [cmd] [len] [data...] [crc16] 0x55`
- CRC: CRC16/XMODEM
- See bootloader documentation for protocol details

---

## Verification

### 1. Verify Flash Contents

After flashing, verify the flash was written correctly:

**Using OpenOCD:**
```bash
openocd -f interface/stlink.cfg -f target/stm32f4x.cfg
```

Then in telnet session (`telnet localhost 4444`):
```
init
halt
mdw 0x08000000 16    # Read first 16 words
compare_image rt950pro_firmware.bin 0x08000000
```

### 2. Check Vector Table

The first word of flash should contain the initial stack pointer value (`0x20018000`):

```bash
# Read first 4 bytes
openocd -f interface/stlink.cfg -f target/stm32f4x.cfg -c "init; halt; mdw 0x08000000 1"
```

Expected: `0x20018000` (or similar, depending on your linker script)

### 3. Reset and Test

1. Reset the radio (power cycle or press reset button)
2. Observe behavior:
   - Display should initialize
   - LEDs should indicate status
   - Keypad should respond

---

## Troubleshooting

### Build Issues

#### "arm-none-eabi-gcc: command not found"

**Solution:**
- Verify ARM toolchain is installed and in PATH
- Windows: Check PATH includes `C:\Program Files (x86)\GNU Arm Embedded Toolchain\10 2021.10\bin`
- Restart terminal/IDE after adding to PATH

#### "CMake Error: Could not find toolchain file"

**Solution:**
```bash
# Specify toolchain explicitly
cmake ../.. -DCMAKE_C_COMPILER=arm-none-eabi-gcc
```

#### Build fails with linker errors

**Possible causes:**
- Missing source files
- Incorrect linker script path
- Memory region overflow

**Solution:**
- Check `build/output/rt950pro_firmware.map` for details
- Verify linker script exists: `src/arch/AT32F403AxG_FLASH.ld`
- Check memory usage with `arm-none-eabi-size`

### Flashing Issues

#### OpenOCD: "Error: open failed"

**Solutions:**
1. Check ST-Link is connected and drivers installed
2. Try different USB port/cable
3. Verify interface config matches your programmer:
   ```bash
   # For ST-Link V2
   openocd -f interface/stlink-v2.cfg -f target/stm32f4x.cfg
   
   # For ST-Link V3
   openocd -f interface/stlink.cfg -f target/stm32f4x.cfg
   ```

#### "Target not examined"

**Solutions:**
1. Verify power is applied to the radio
2. Check SWD connections (SWDIO, SWCLK, GND)
3. Try slower SWD speed:
   ```tcl
   adapter speed 1000
   ```

#### Flash verification fails

**Solutions:**
1. Re-flash the firmware
2. Check for bad connections
3. Try erasing flash first:
   ```tcl
   init
   halt
   stm32f4x mass_erase 0
   program rt950pro_firmware.elf verify reset exit
   ```

#### Radio doesn't boot after flashing

**Possible causes:**
- Corrupted flash
- Wrong memory address
- Invalid firmware image

**Solutions:**
1. Restore original backup firmware
2. Verify firmware binary is correct size
3. Check vector table is at correct address (0x08000000)
4. Verify stack pointer in vector table is valid

### Runtime Issues

#### Radio boots but display is blank

**Possible causes:**
- Display driver not initialized
- Incorrect pin configuration
- Missing frame buffer initialization

**Debug steps:**
1. Connect SWD debugger
2. Set breakpoints in display initialization code
3. Check GPIO pins with logic analyzer

#### Radio freezes or crashes

**Possible causes:**
- Stack overflow
- Invalid memory access
- Interrupt handler issues

**Debug steps:**
1. Use SWD debugger to examine crash location
2. Check stack pointer is within valid range (0x20000000 - 0x20018000)
3. Review memory map for conflicts

---

## Advanced Topics

### Debugging with GDB

Connect GDB to OpenOCD for interactive debugging:

**Terminal 1 (OpenOCD):**
```bash
openocd -f interface/stlink.cfg -f target/stm32f4x.cfg
```

**Terminal 2 (GDB):**
```bash
arm-none-eabi-gdb rt950pro_firmware.elf
(gdb) target remote localhost:3333
(gdb) monitor reset halt
(gdb) load
(gdb) continue
```

### Custom Build Options

Add compile definitions:

```bash
cmake ../.. -DCMAKE_BUILD_TYPE=Release \
  -DENABLE_GPS=ON \
  -DENABLE_BLUETOOTH=ON \
  -DCUSTOM_FLAG=value
```

### Cross-Compiling

The build system is already configured for cross-compilation. To use a different toolchain prefix:

```bash
cmake ../.. -DCMAKE_C_COMPILER=arm-none-eabi-gcc \
  -DCMAKE_ASM_COMPILER=arm-none-eabi-gcc \
  -DCMAKE_AR=arm-none-eabi-ar
```

---

## Additional Resources

- [AT32F403A Datasheet](../Datasheets/DS_AT32F403A_V2.04_EN.pdf)
- [AT32F403A Reference Manual](../Datasheets/RM_AT32F403A_407_V2.07_EN.pdf)
- [Pinout Documentation](./pinout.md)
- [Project README](../README.md)

---

## Support

If you encounter issues not covered in this guide:

1. Check the [troubleshooting section](#troubleshooting) above
2. Review build output logs and error messages
3. Check GitHub Issues: https://github.com/Dadud/radtel-950-pro/issues
4. Consult the main [README.md](../README.md) for project status

---

**Last Updated:** 2025-01-27

